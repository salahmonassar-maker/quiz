<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>اختبار الطالب</title>
<style>
body{font-family:Tahoma;direction:rtl;background:#020617;color:#fff}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:#1e293b;padding:20px;border-radius:15px;margin-bottom:20px}
label{display:block;background:#334155;padding:10px;margin:8px;border-radius:8px}
#timer{background:#dc2626;padding:10px;border-radius:10px;text-align:center}
</style>
</head>

<body>
<div class="container">

<h1 id="title">اختبار</h1>

<div class="card">
<input id="subject" placeholder="المادة">
<input id="topic" placeholder="الموضوع">
<input id="student" placeholder="اسم الطالب">
<button onclick="start()">ابدأ</button>
</div>

<div id="timer"></div>
<div id="quiz"></div>
<div id="result"></div>

</div>

<script>
const FORM_URL="https://docs.google.com/forms/d/e/1FAIpQLScfAkat7dEs9N8CaQQ2ytZY9oV9GcXcEXxWGVcNiNLrBkqXDQ/formResponse";
const EN_NAME="entry.1210043991";
const EN_SCORE="entry.1822773689";
const EN_SUB="entry.1713670424";
const EN_TOP="entry.1872836989";

let data,selected=[],timeLeft,intv;

function start(){
  let key="quiz_"+subject.value+"_"+topic.value;
  data=JSON.parse(localStorage.getItem(key));
  if(!data){alert("لا يوجد اختبار");return;}

  title.innerText=subject.value+" - "+topic.value;
  selected=[];
  let used=[];

  while(selected.length<data.qCount){
    let i=Math.floor(Math.random()*data.questions.length);
    if(!used.includes(i)){used.push(i);selected.push(data.questions[i]);}
  }

  quiz.innerHTML="";
  selected.forEach((q,i)=>{
    let d=document.createElement("div");
    d.className="card";
    d.innerHTML="<h3>"+q.q+"</h3>";
    q.o.forEach((op,j)=>{
      d.innerHTML+=`<label>
      <input type="radio" name="q${i}" value="${j}"> ${op}
      </label>`;
    });
    quiz.appendChild(d);
  });

  let b=document.createElement("button");
  b.innerText="إنهاء";
  b.onclick=finish;
  quiz.appendChild(b);

  startTimer(data.timeLimit);
}

function startTimer(min){
  timeLeft=min*60;
  intv=setInterval(()=>{
    timer.innerText="⏱ "+Math.floor(timeLeft/60)+":"+timeLeft%60;
    timeLeft--;
    if(timeLeft<0){clearInterval(intv);finish();}
  },1000);
}

function finish(){
  clearInterval(intv);
  let score=0;
  selected.forEach((q,i)=>{
    let r=document.querySelector(`input[name="q${i}"]:checked`);
    if(r && r.value==q.a)score++;
  });

  let p=new URLSearchParams();
  p.append(EN_NAME,student.value);
  p.append(EN_SCORE,score+"/"+selected.length);
  p.append(EN_SUB,subject.value);
  p.append(EN_TOP,topic.value);

  fetch(FORM_URL,{method:"POST",mode:"no-cors",body:p});

  quiz.innerHTML="";
  result.innerHTML=`<h2>درجتك ${score}/${selected.length}</h2>`;
}
</script>
</body>
</html>